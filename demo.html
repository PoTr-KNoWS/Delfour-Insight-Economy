<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Delfour Insight Economy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="color-scheme" content="light" />
    <style>
      html, body { height: 100%; }
      pre { white-space: pre-wrap; word-break: break-word; }
    </style>
  </head>
  <body class="bg-gradient-to-b from-slate-50 to-white text-slate-900 min-h-screen">
    <main class="max-w-6xl mx-auto p-6">
      <header class="mb-6">
        <h1 class="text-2xl font-bold">Delfour Insight Economy</h1>
        <p class="text-slate-600">
          Runs fully client-side. Reasoning by <span class="font-mono">eye-js</span>; orchestration in Python (Pyodide).
        </p>
      </header>

      <div class="flex items-center gap-3 mb-6">
        <button id="runBtn"
                class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-500 disabled:opacity-50">
          Run Demo
        </button>
        <span id="status" class="text-sm text-slate-600"></span>
      </div>

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left column -->
        <div class="space-y-4">
          <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
            <h3 class="text-lg font-semibold mb-2">Timeline</h3>
            <ul id="timeline" class="text-sm space-y-1"></ul>
          </div>

          <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
            <h3 class="text-lg font-semibold mb-2">Answer — Insight (to retailer)</h3>
            <pre id="insight" class="text-xs"></pre>
          </div>

          <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
            <h3 class="text-lg font-semibold mb-2">Reason Why (private)</h3>
            <pre id="reason" class="text-sm text-slate-800"></pre>
          </div>
        </div>

        <!-- Right column -->
        <div class="space-y-4">
          <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
            <h3 class="text-lg font-semibold mb-2">Answer — Runtime Preview (device)</h3>
            <pre id="banner" class="text-xs text-slate-800"></pre>
          </div>

          <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
            <h3 class="text-lg font-semibold mb-2">Checks</h3>
            <div id="checks" class="text-sm space-y-1"></div>
          </div>

          <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
            <h3 class="text-lg font-semibold mb-2">Audit (derived)</h3>
            <pre id="audit" class="text-xs text-slate-800"></pre>
          </div>
        </div>
      </section>

      <footer class="mt-8 text-xs text-slate-500">
        Powered by <a class="underline" href="https://github.com/eyereasoner/eye-js" target="_blank" rel="noreferrer">eye-js</a> + Pyodide.
      </footer>
    </main>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.3/full/pyodide.js"></script>

    <script type="module">
      // ---------- Minimal UI helpers ----------
      const statusEl = document.getElementById("status");
      const runBtn   = document.getElementById("runBtn");
      const auditEl  = document.getElementById("audit");

      function setStatus(msg) { statusEl.textContent = msg; }
      function clearUI() {
        document.getElementById("timeline").innerHTML = "";
        document.getElementById("insight").textContent = "";
        document.getElementById("banner").textContent = "";
        document.getElementById("reason").textContent = "";
        document.getElementById("checks").innerHTML = "";
        if (auditEl) auditEl.textContent = "";
      }
      function addTimeline(ts, ev, detail) {
        const li = document.createElement("li");
        li.className = "flex gap-2";
        const tsSpan = document.createElement("span");
        tsSpan.className = "text-slate-400 w-28 shrink-0";
        tsSpan.textContent = new Date(ts).toLocaleTimeString();
        const evSpan = document.createElement("span");
        evSpan.className = "font-semibold w-36 shrink-0";
        evSpan.textContent = ev;
        const deSpan = document.createElement("span");
        deSpan.className = "text-slate-700";
        deSpan.textContent = detail || "";
        li.append(tsSpan, evSpan, deSpan);
        document.getElementById("timeline").appendChild(li);
      }
      function showInsight(n3) { document.getElementById("insight").textContent = (n3||"").trim(); }
      function showBanner(obj) { document.getElementById("banner").textContent = JSON.stringify(obj, null, 2); }
      function showReason(txt) { document.getElementById("reason").textContent = txt || ""; }
      function showChecks(checksArr) {
        const box = document.getElementById("checks");
        box.innerHTML = "";
        checksArr.forEach(([name, ok]) => {
          const row = document.createElement("div");
          row.className = "flex items-center gap-2";
          const badge = document.createElement("span");
          badge.className = "inline-flex h-5 w-5 items-center justify-center rounded-full " + (ok ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700");
          badge.textContent = ok ? "✓" : "✗";
          const label = document.createElement("span");
          label.textContent = name;
          row.append(badge, label);
          box.appendChild(row);
        });
      }

      // Load eye-js (browser bundle) and Pyodide
      setStatus("Loading eye-js…");
      const eyeMod = await import("https://eyereasoner.github.io/eye-js/latest/dynamic-import.js");
      if (!eyeMod.eyereasoner?.n3reasoner) {
        setStatus("Failed to load eye-js");
        throw new Error("eye-js n3reasoner not available");
      }
      window.n3reasoner = eyeMod.eyereasoner.n3reasoner;

      setStatus("Loading Python runtime…");
      const pyodide = await loadPyodide();

      // Expose JS helpers to Python
      window._delfourHelpers = {
        addTimeline,
        showInsight,
        showBanner,
        showChecks,
        showReason,
        setAudit: (txt) => { if (auditEl) auditEl.textContent = txt || ""; },
        n3reasoner: window.n3reasoner
      };

      // ---------- Python program (Pyodide) ----------
      const pyCode = `
import json, re
from js import _delfourHelpers
from pyodide.ffi import to_js
from datetime import datetime, timedelta, timezone

def nowISO():
    return datetime.now(timezone.utc).isoformat()

def log(event, detail=""):
    _delfourHelpers.addTimeline(nowISO(), event, detail)

# -------- Sample data & rules (typed decimals; FILTER-free) --------
profile = """@prefix : <https://example.org/person#> .
@prefix health: <https://example.org/health#> .
:me  health:householdCondition  health:Diabetes .
"""

catalog = """@prefix prod: <https://example.org/product#> .
@prefix schema: <http://schema.org/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

prod:BIS_001 a schema:Product ; schema:name "Classic Tea Biscuits" ; schema:sku "BIS-001" ; schema:sugarContent "12.0"^^xsd:decimal ; schema:price "2.10"^^xsd:decimal .
prod:BIS_101 a schema:Product ; schema:name "Low-Sugar Tea Biscuits" ; schema:sku "BIS-101" ; schema:sugarContent "3.0"^^xsd:decimal  ; schema:price "2.60"^^xsd:decimal .
prod:CHOC_050 a schema:Product ; schema:name "Milk Chocolate Bar"   ; schema:sku "CHOC-050" ; schema:sugarContent "15.0"^^xsd:decimal ; schema:price "1.80"^^xsd:decimal .
prod:CHOC_150 a schema:Product ; schema:name "85% Dark Chocolate"   ; schema:sku "CHOC-150" ; schema:sugarContent "6.0"^^xsd:decimal  ; schema:price "2.20"^^xsd:decimal .
"""

desensitize_rule = """@prefix health: <https://example.org/health#> .
@prefix need:   <https://example.org/need#> .
{ ?p health:householdCondition health:Diabetes. } => { ?p need:needsLowSugar true. } .
"""

derive_rule = """@prefix need: <https://example.org/need#> .
@prefix ctx:  <https://example.org/context#> .
@prefix ins:  <https://example.org/insight#> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
{
  ?p need:needsLowSugar true.
  ?c ctx:retailer "Delfour";
     ctx:device   "self-scanner";
     ctx:event    "pick_up_scanner";
     ctx:expiresAt ?exp.
}
=>
{
  _:ins a ins:Insight ;
    ins:metric           "sugar_g_per_serving" ;
    ins:threshold        "10.0"^^xsd:decimal ;
    ins:suggestionPolicy "lower_metric_first_higher_price_ok" ;
    ins:scopeDevice      "self-scanner" ;
    ins:scopeEvent       "pick_up_scanner" ;
    ins:retailer         "Delfour" ;
    ins:expiresAt        ?exp .
}.
"""

# ODRL policy from insight
odrl_from_insight = """@prefix ins:  <https://example.org/insight#> .
@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
{
  ?ins a ins:Insight ;
       ins:expiresAt ?exp ;
       ins:retailer "Delfour" ;
       ins:scopeDevice "self-scanner" ;
       ins:scopeEvent  "pick_up_scanner" .
}
=>
{
  _:pol a odrl:Policy ;
        odrl:profile "Delfour-Insight-Policy" ;
        odrl:permission [
          odrl:action odrl:use ;
          odrl:target ?ins ;
          odrl:constraint [
            odrl:leftOperand odrl:purpose ;
            odrl:operator    odrl:eq ;
            odrl:rightOperand "shopping_assist"
          ]
        ] ;
        odrl:prohibition [
          odrl:action odrl:share ;
          odrl:target ?ins ;
          odrl:constraint [
            odrl:leftOperand odrl:purpose ;
            odrl:operator    odrl:eq ;
            odrl:rightOperand "marketing"
          ]
        ] ;
        odrl:duty [
          odrl:action odrl:delete ;
          odrl:constraint [
            odrl:leftOperand odrl:dateTime ;
            odrl:operator    odrl:eq ;
            odrl:rightOperand ?exp
          ]
        ] .
}.
"""

# Pure-rule enforcement + expiry guard + audit + fallback
odrl_enforce = """@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix ins:  <https://example.org/insight#> .
@prefix ex:   <https://example.org/enforce#> .
@prefix act:  <https://example.org/activity#> .

# Allowed if permission matches (use@shopping_assist) over some Insight target
{
  ?pol a odrl:Policy ;
       odrl:permission [
         odrl:action odrl:use ;
         odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:operator odrl:eq ; odrl:rightOperand "shopping_assist" ] ;
         odrl:target ?ins
       ] .
  ?ins a ins:Insight .
  ?req odrl:action odrl:use ;
       odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:rightOperand "shopping_assist" ] .
}
=>
{ ?req a ex:Allowed ; ex:target ?ins . } .

# Block if target expired (expiry is derived elsewhere)
{
  ?req a ex:Allowed ; ex:target ?ins .
  ?ins a ex:Expired .
}
=>
{ ?req a ex:Blocked ; ex:reason "expired" . } .
"""

expiry_guard = """@prefix ins:  <https://example.org/insight#> .
@prefix ex:   <https://example.org/enforce#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .
# Mark Expired when exp < now (typed xsd:dateTime comparison)
{
  ?ins a ins:Insight ; ins:expiresAt ?exp .
  []   ex:now ?now .
  ?exp math:lessThan ?now .
}
=> { ?ins a ex:Expired . } .
"""

audit_rules = """@prefix ex:   <https://example.org/enforce#> .
@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix act:  <https://example.org/activity#> .

{ ?req a ex:Allowed . [] ex:now ?now . }
=> { _:a a act:Decision ; act:at ?now ; act:request ?req ; act:outcome "Allowed" . } .

{ ?req a ex:Blocked ; ex:reason ?r . [] ex:now ?now . }
=> { _:a a act:Decision ; act:at ?now ; act:request ?req ; act:outcome "Blocked" ; act:reason ?r . } .

{ ?ins a ex:Expired . [] ex:now ?now . }
=> { _:a a act:Duty ; act:type "delete_due" ; act:at ?now ; act:target ?ins . } .
"""

audit_fallback = """@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix act:  <https://example.org/activity#> .
@prefix ex:   <https://example.org/enforce#> .
{
  {} log:semantics ?KB .
  ?R odrl:action odrl:use .
  ?KB log:notIncludes { ?R a act:Decision } .
  [] ex:now ?now .
}
=> { _:a a act:Decision ; act:at ?now ; act:request ?R ; act:outcome "Blocked" ; act:reason "no_decision" } .
"""

shopping_rule = """@prefix ins:   <https://example.org/insight#> .
@prefix schema: <http://schema.org/> .
@prefix shop:  <https://example.org/shop#> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix math:  <http://www.w3.org/2000/10/swap/math#> .
{
  ?ins a ins:Insight; ins:metric "sugar_g_per_serving"; ins:threshold ?thr.
  ?scan shop:scannedProduct ?p.
  ?p schema:name ?name; schema:sugarContent ?sug.
  ?sug math:notLessThan ?thr.
  ?alt schema:name ?an ; schema:sugarContent ?as ; schema:price ?ap .
  ?as math:lessThan ?sug.
}
=> { ?scan shop:note "High sugar" ; shop:suggestedAlternative ?alt . } .
"""

# -------- Helpers --------
def build_context():
    now = datetime.now(timezone.utc)
    exp = now + timedelta(hours=2)
    return f"""@prefix ctx: <https://example.org/context#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
[] ctx:retailer "Delfour" ;
   ctx:device   "self-scanner" ;
   ctx:event    "pick_up_scanner" ;
   ctx:timestamp "{now.isoformat()}"^^xsd:dateTime ;
   ctx:expiresAt "{exp.isoformat()}"^^xsd:dateTime .
"""

n3reasoner = _delfourHelpers.n3reasoner

async def run_pipeline():
    # 01 pickup + 02 dialog
    log("PICKUP", 'scanner="self-scanner" retailer="Delfour"')
    log("AGENT-DIALOG", "capabilities received from Delfour")
    context = build_context()

    # 03 desensitize
    need = await n3reasoner([profile, desensitize_rule], None, to_js({"output":"derivations", "outputType":"string"}))
    log("DESENSITIZE", "need=needsLowSugar written")

    # 04 derive insight
    insight = await n3reasoner([need, context, derive_rule], None, to_js({"output":"derivations", "outputType":"string"}))
    _delfourHelpers.showInsight(insight)
    log("INSIGHT", "neutral low-sugar envelope emitted")

    # 04b (optional) derive policy alone (for display/logging if you want)
    policy_preview = await n3reasoner([insight, odrl_from_insight], None, to_js({"output":"derivations", "outputType":"string"}))
    log("POLICY", "ODRL policy emitted (use@shopping_assist; share@marketing prohibited)")

    # 05 auth: now + request + expiry guard + enforcement + audit (+policy rule inline) + fallback
    now = nowISO()
    now_ttl = (
        '@prefix ex: <https://example.org/enforce#> .\\n'
        '@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .\\n'
        f'[] ex:now "{now}"^^xsd:dateTime .\\n'
    )
    req_ttl = '@prefix odrl: <http://www.w3.org/ns/odrl/2/> .\\n@prefix req: <https://example.org/request#> .\\nreq:r1 odrl:action odrl:use ; odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:rightOperand "shopping_assist" ] .\\n'
    auth_out = await n3reasoner(
        [insight, odrl_from_insight, now_ttl, req_ttl, expiry_guard, odrl_enforce, audit_rules, audit_fallback],
        None,
        to_js({"output":"derivations", "outputType":"string"})
    )

    # EXPIRY + AUTH timeline breadcrumbs
    expired = ("ex:Expired" in auth_out)
    if expired: log("EXPIRY", "insight expired at now()")

    has_decision = ("activity#Decision" in auth_out) or ("act:Decision" in auth_out)
    allowed = has_decision and ("Allowed" in auth_out) and not ("Blocked" in auth_out)
    blocked = has_decision and ("Blocked" in auth_out)
    if allowed:
        log("AUTH", "Allowed (use@shopping_assist)")
    elif blocked:
        reason = "expired" if "expired" in auth_out else ("prohibited" if "prohibited" in auth_out else "no_decision")
        log("AUTH", f"Blocked ({reason})")
    else:
        log("AUTH", "No explicit decision (check policy/request)")

    # Pretty audit text
    _delfourHelpers.setAudit(auth_out)
    log("AUDIT", "authorization decision recorded")

    # 05 shopping — only if not blocked
    if blocked and not allowed:
        banner = {
            "headline": "Policy blocked action",
            "product_name": None,
            "note": "Expired or prohibited",
            "suggested_alternative": None
        }
        _delfourHelpers.showBanner(json.dumps(banner, indent=2))
        # Checks + Reason + exit
        reason = "Household requires low-sugar guidance (diabetes in POD). You are starting a self-scanner session at Delfour right now. Envelope is minimized and limited to this session."
        _delfourHelpers.showReason(reason)
        txt = (insight or "").lower()
        checks = [
            ("insight_nonempty", bool(insight.strip())),
            ("minimization_no_sensitive_terms", ("diabetes" not in txt and "medical" not in txt)),
            ("scope_has_device_event_expiry", all(k in txt for k in ["scopedevice","scopeevent","expiresat"])),
            ("runtime_present", True),
            ("behavior_suggests_on_high_sugar", False),
            ("audit_has_decision", has_decision)
        ]
        _delfourHelpers.showChecks(checks)
        return

    # If Allowed, simulate scan & suggestion
    scan_ttl = "@prefix shop: <https://example.org/shop#> .\\n@prefix prod: <https://example.org/product#> .\\n[] shop:scannedProduct prod:BIS_001 ."
    sugg = await n3reasoner([insight, catalog, scan_ttl, shopping_rule], None, to_js({"output":"derivations", "outputType":"string"}))
    m = re.search(r"shop:suggestedAlternative\\s+([^\\s]+)\\s*\\.", sugg)
    alt_qname = m.group(1) if m else None

    def name_for(qname: str|None) -> str|None:
        if not qname: return None
        patt = re.compile(re.escape(qname) + r"\\b[\\s\\S]*?schema:name\\s+\\\"([^\\\"]+)\\\"")
        m2 = patt.search(catalog)
        return m2.group(1) if m2 else None

    scanned_qname = "prod:BIS_001"
    scanned_name = name_for(scanned_qname) or "Unknown"
    alt_name = name_for(alt_qname) or ("present" if alt_qname else None)
    banner = {
        "headline": "Track sugar per serving while you scan",
        "product_name": scanned_name,
        "note": "High sugar" if alt_qname else None,
        "suggested_alternative": alt_name if alt_qname else None
    }
    _delfourHelpers.showBanner(json.dumps(banner, indent=2))
    if alt_qname:
        log("SCAN", f'product="{scanned_name}" \\u2192 suggest="{alt_name}"')
    else:
        log("SCAN", f'product="{scanned_name}" (ok)')
    log("RUNTIME", "banner written")

    # 06 drop + close-out duty audit (reuse audit_rules + expiry_guard with new now)
    log("DROP", "scanner returned; session closed")
    now2 = nowISO()
    close_now = (
        '@prefix ex: <https://example.org/enforce#> .\\n'
        '@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .\\n'
        f'[] ex:now "{now2}"^^xsd:dateTime .\\n'
    )
    close_out = await n3reasoner([insight, close_now, expiry_guard, audit_rules], None, to_js({"output":"derivations", "outputType":"string"}))
    if close_out.strip():
        _delfourHelpers.setAudit(auth_out.strip() + "\\n" + close_out.strip())
        log("AUDIT", "close-out appended" + (" (delete_due)" if ("act:Duty" in close_out and 'act:type "delete_due"' in close_out) else ""))

    # Reason & Checks
    reason = "Household requires low-sugar guidance (diabetes in POD). You are starting a self-scanner session at Delfour right now. Envelope is minimized and limited to this session."
    _delfourHelpers.showReason(reason)
    txt = (insight or "").lower()
    checks = [
        ("insight_nonempty", bool(insight.strip())),
        ("minimization_no_sensitive_terms", ("diabetes" not in txt and "medical" not in txt)),
        ("scope_has_device_event_expiry", all(k in txt for k in ["scopedevice","scopeevent","expiresat"])),
        ("runtime_present", True),
        ("behavior_suggests_on_high_sugar", bool(alt_qname)),
        ("audit_has_decision", True if (("activity#Decision" in auth_out) or ("act:Decision" in auth_out)) else False),
    ]
    _delfourHelpers.showChecks(checks)

    return "ok"
`;

      async function runDemo() {
        clearUI();
        runBtn.disabled = true;
        setStatus("Running…");
        try {
          await pyodide.runPythonAsync(pyCode + "\nimport asyncio\nawait run_pipeline()\n");
          setStatus("Done.");
        } catch (e) {
          console.error(e);
          setStatus("Error: " + (e?.message || e));
        } finally {
          runBtn.disabled = false;
        }
      }

      runBtn.addEventListener("click", runDemo);
      setStatus("Ready.");
    </script>
  </body>
</html>

