<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Delfour Insight Economy — Phone ↔ Scanner (Pyodide + eye-js)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light" />
  <style>html, body { height: 100%; } pre { white-space: pre-wrap; word-break: break-word; }</style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-white text-slate-900 min-h-screen">
  <main class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Delfour Insight Economy — Phone ↔ Scanner</h1>
      <p class="text-slate-600">
        Fully client-side. Python orchestration in Pyodide, reasoning by <span class="font-mono">eye-js</span>, signing by <span class="font-mono">TweetNaCl</span>.
      </p>
    </header>

    <div class="flex items-center gap-3 mb-6">
      <button id="runBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-500 disabled:opacity-50">Run Demo</button>
      <span id="status" class="text-sm text-slate-600"></span>
      <label class="ml-4 text-sm text-slate-700 flex items-center gap-2">
        Session:
        <input id="sessionId" value="S1" class="px-2 py-1 border rounded-md" />
      </label>
    </div>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- PHONE -->
      <div class="space-y-4">
        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">Phone (shopper)</h3>
          <ul id="phoneTimeline" class="text-sm space-y-1"></ul>
        </div>

        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">insight.ttl</h3>
          <pre id="insightBox" class="text-xs"></pre>
        </div>

        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">policy.ttl</h3>
          <pre id="policyBox" class="text-xs"></pre>
        </div>

        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">envelope.sig.json</h3>
          <pre id="sigBox" class="text-xs"></pre>
        </div>
      </div>

      <!-- SCANNER -->
      <div class="space-y-4">
        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">Scanner (retailer)</h3>
          <ul id="scannerTimeline" class="text-sm space-y-1"></ul>
        </div>

        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">banner.json (preview)</h3>
          <pre id="bannerBox" class="text-xs"></pre>
        </div>

        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">Audit (derived)</h3>
          <pre id="auditBox" class="text-xs"></pre>
        </div>

        <!-- NEW: Reason Why -->
        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">Reason Why (private)</h3>
          <pre id="reasonBox" class="text-sm text-slate-800"></pre>
        </div>

        <!-- NEW: Checks harness -->
        <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
          <h3 class="text-lg font-semibold mb-2">Checks (harness)</h3>
          <div id="checksBox" class="text-sm space-y-1"></div>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-xs text-slate-500">
      Powered by <a class="underline" href="https://github.com/eyereasoner/eye-js" target="_blank" rel="noreferrer">eye-js</a>, Pyodide &amp; TweetNaCl.
    </footer>
  </main>

  <!-- Pyodide and TweetNaCl -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.3/full/pyodide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>

  <script type="module">
    // ---- UI helpers
    const $ = (id)=>document.getElementById(id);
    const statusEl = $("status"), runBtn=$("runBtn");
    const phoneTL = $("phoneTimeline"), scanTL = $("scannerTimeline");

    function addTL(ul, ev, detail="") {
      const li = document.createElement("li");
      li.className = "flex gap-2";
      li.innerHTML = `<span class="text-slate-400 w-28 shrink-0">${new Date().toLocaleTimeString()}</span>
                      <span class="font-semibold w-36 shrink-0">${ev}</span>
                      <span class="text-slate-700">${detail}</span>`;
      ul.appendChild(li);
    }
    function resetUI(){
      phoneTL.innerHTML = ""; scanTL.innerHTML = "";
      ["insightBox","policyBox","sigBox","bannerBox","auditBox","reasonBox"].forEach(id => $(id).textContent = "");
      $("checksBox").innerHTML = "";
    }
    function setStatus(s){ statusEl.textContent = s; }

    function renderChecks(arr) {
      const box = $("checksBox");
      box.innerHTML = "";
      (arr || []).forEach(([name, ok]) => {
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        const badge = document.createElement("span");
        badge.className = "inline-flex h-5 w-5 items-center justify-center rounded-full " + (ok ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700");
        badge.textContent = ok ? "✓" : "✗";
        const label = document.createElement("span");
        label.textContent = name;
        row.append(badge, label);
        box.appendChild(row);
      });
    }

    // ---- Load eye-js
    setStatus("Loading eye-js…");
    const eyeMod = await import("https://eyereasoner.github.io/eye-js/latest/dynamic-import.js");
    if (!eyeMod.eyereasoner?.n3reasoner) { throw new Error("eye-js n3reasoner not available"); }
    const n3reasoner = eyeMod.eyereasoner.n3reasoner;

    // ---- Load Pyodide
    setStatus("Loading Python…");
    const pyodide = await loadPyodide();

    // ---- Crypto helpers (TweetNaCl) exposed to Python
    const encoder = new TextEncoder();
    const keypair = nacl.sign.keyPair(); // ephemeral for demo

    async function signPayload(payloadStr) {
      const bytes = encoder.encode(payloadStr);
      const sig = nacl.sign.detached(bytes, keypair.secretKey);
      const hashBuf = await crypto.subtle.digest("SHA-256", bytes);
      const hashHex = [...new Uint8Array(hashBuf)].map(b=>b.toString(16).padStart(2,"0")).join("");
      return {
        alg: "Ed25519",
        keyid: "ed25519:default",
        created: new Date().toISOString().replace(/\.\d+Z$/,"Z"),
        publicKeyBase64: btoa(String.fromCharCode(...keypair.publicKey)),
        payloadHashSHA256: hashHex,
        signatureBase64: btoa(String.fromCharCode(...sig))
      };
    }

    async function verifyPayload(payloadStr, sigObj){
      const bytes = encoder.encode(payloadStr);
      const pkB64  = String(sigObj.publicKeyBase64 ?? "").replace(/\s+/g, "");
      const sigB64 = String(sigObj.signatureBase64 ?? "").replace(/\s+/g, "");
      if (!pkB64 || !sigB64) return false;
      const pk  = Uint8Array.from(atob(pkB64),  c => c.charCodeAt(0));
      const sig = Uint8Array.from(atob(sigB64), c => c.charCodeAt(0));
      const hashBuf = await crypto.subtle.digest("SHA-256", bytes);
      const hashHex = [...new Uint8Array(hashBuf)].map(b=>b.toString(16).padStart(2,"0")).join("");
      if (hashHex.toLowerCase() !== String(sigObj.payloadHashSHA256 ?? "").toLowerCase()) return false;
      return nacl.sign.detached.verify(bytes, sig, pk);
    }

    // expose helpers to Python
    window._bridge = {
      n3reasoner,
      addPhoneTL: (e,d)=>addTL(phoneTL, e, d),
      addScanTL:  (e,d)=>addTL(scanTL, e, d),
      setTxt: (id, txt)=>($(id).textContent = txt || ""),
      setChecks: (arr)=>renderChecks(arr),
      signPayload: (payload) => signPayload(payload),
      verifyPayload: async (payload, sig) => await verifyPayload(payload, sig)
    };

    // ---- Python program (phone ↔ scanner; in-memory bus)
    const py = `
import json, re, asyncio
from datetime import datetime, timedelta, timezone
from js import _bridge
from pyodide.ffi import to_js, create_proxy

def strip_prefixes(n3:str)->str:
    return "\\n".join(ln for ln in n3.splitlines() if not ln.lstrip().startswith("@prefix")).strip()

def canonicalize_ttl(text: str) -> str:
    lines=[]
    for ln in text.splitlines():
        s = ln.strip()
        if not s or s.startswith("@prefix"): continue
        s = " ".join(s.split())
        lines.append(s)
    lines.sort()
    return "\\n".join(lines) + ("\\n" if lines else "")

class Bus:
    def __init__(self): self.files={}
    def write(self, path, content): self.files[path]=content
    def read(self, path): return self.files[path]

bus = Bus()
n3reasoner = _bridge.n3reasoner

PROFILE = """@prefix :       <https://example.org/person#> .
@prefix health: <https://example.org/health#> .
:me  health:householdCondition  health:Diabetes .
"""

DESENSITIZE_RULE = """@prefix health: <https://example.org/health#> .
@prefix need:   <https://example.org/need#> .
{ ?p health:householdCondition health:Diabetes. } => { ?p need:needsLowSugar true. } .
"""

DERIVE_RULE_TPL = """@prefix need: <https://example.org/need#> .
@prefix ctx:  <https://example.org/context#> .
@prefix ins:  <https://example.org/insight#> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
{ ?p need:needsLowSugar true.
  ?c ctx:retailer ?ret ; ctx:device ?dev ; ctx:event ?ev ; ctx:expiresAt ?exp. }
=>
{ %(INS_IRI)s a ins:Insight ;
  ins:metric "sugar_g_per_serving" ;
  ins:threshold "10.0"^^xsd:decimal ;
  ins:suggestionPolicy "lower_metric_first_higher_price_ok" ;
  ins:scopeDevice ?dev ; ins:scopeEvent ?ev ; ins:retailer ?ret ; ins:expiresAt ?exp . } .
"""

ODRL_FROM_INSIGHT_TPL = """@prefix ins:  <https://example.org/insight#> .
@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
{ %(INS_IRI)s a ins:Insight ; ins:expiresAt ?exp ; ins:retailer ?ret ; ins:scopeDevice ?dev ; ins:scopeEvent ?ev . }
=>
{ _:pol a odrl:Policy ; odrl:profile "Delfour-Insight-Policy" ;
  odrl:permission [ odrl:action odrl:use ;
                    odrl:target %(INS_IRI)s ;
                    odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:operator odrl:eq ; odrl:rightOperand "shopping_assist" ] ] ;
  odrl:prohibition [ odrl:action odrl:share ; odrl:target %(INS_IRI)s ;
                     odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:operator odrl:eq ; odrl:rightOperand "marketing" ] ] ;
  odrl:duty [ odrl:action odrl:delete ;
              odrl:constraint [ odrl:leftOperand odrl:dateTime ; odrl:operator odrl:eq ; odrl:rightOperand ?exp ] ] . } .
"""

ODRL_ENFORCE = """@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix ins:  <https://example.org/insight#> .
@prefix ex:   <https://example.org/enforce#> .
{ ?pol a odrl:Policy ;
       odrl:permission [ odrl:action odrl:use ;
                         odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:operator odrl:eq ; odrl:rightOperand "shopping_assist" ] ;
                         odrl:target ?ins ] .
  ?ins a ins:Insight .
  ?req odrl:action odrl:use ; odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:rightOperand "shopping_assist" ] . }
=> { ?req a ex:Allowed ; ex:target ?ins . } .
{ ?req a ex:Allowed ; ex:target ?ins . ?ins a ex:Expired . }
=> { ?req a ex:Blocked ; ex:reason "expired" . } .
"""

EXPIRY_GUARD = """@prefix ins:  <https://example.org/insight#> .
@prefix ex:   <https://example.org/enforce#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .
{ ?ins a ins:Insight ; ins:expiresAt ?exp . [] ex:now ?now . ?exp math:lessThan ?now . }
=> { ?ins a ex:Expired . } .
"""

AUDIT_RULES = """@prefix ex:   <https://example.org/enforce#> .
@prefix act:  <https://example.org/activity#> .
@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix req:  <https://example.org/request#> .
{ ?r a ex:Allowed . ?r a req:Request . [] ex:now ?now . }
=> { _:a a act:Decision ; act:at ?now ; act:request ?r ; act:outcome "Allowed" . } .
{ ?r a ex:Blocked ; ex:reason ?why . ?r a req:Request . [] ex:now ?now . }
=> { _:a a act:Decision ; act:at ?now ; act:request ?r ; act:outcome "Blocked" ; act:reason ?why . } .
{ ?ins a ex:Expired . [] ex:now ?now . }
=> { _:a a act:Duty ; act:type "delete_due" ; act:at ?now ; act:target ?ins . } .
"""

SHOPPING_RULE = """@prefix ins:   <https://example.org/insight#> .
@prefix schema: <http://schema.org/> .
@prefix shop:  <https://example.org/shop#> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix math:  <http://www.w3.org/2000/10/swap/math#> .
{ ?ins a ins:Insight; ins:metric "sugar_g_per_serving"; ins:threshold ?thr.
  ?scan shop:scannedProduct ?p. ?p schema:name ?name; schema:sugarContent ?sug.
  ?sug math:notLessThan ?thr. ?alt schema:name ?an ; schema:sugarContent ?as ; schema:price ?ap . ?as math:lessThan ?sug. }
=> { ?scan shop:note "High sugar" ; shop:suggestedAlternative ?alt . } .
"""

REQUEST_USE = """@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix req:  <https://example.org/request#> .
req:r1 a req:Request ; odrl:action odrl:use ;
      odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:rightOperand "shopping_assist" ] .
"""

CATALOG = """@prefix prod:   <https://example.org/product#> .
@prefix schema: <http://schema.org/> .
@prefix xsd:    <http://www.w3.org/2001/XMLSchema#> .
prod:BIS_001 a schema:Product ; schema:name "Classic Tea Biscuits" ; schema:sku "BIS-001" ; schema:sugarContent "12.0"^^xsd:decimal ; schema:price "2.10"^^xsd:decimal .
prod:BIS_101 a schema:Product ; schema:name "Low-Sugar Tea Biscuits" ; schema:sku "BIS-101" ; schema:sugarContent "3.0"^^xsd:decimal  ; schema:price "2.60"^^xsd:decimal .
prod:CHOC_050 a schema:Product ; schema:name "Milk Chocolate Bar"   ; schema:sku "CHOC-050" ; schema:sugarContent "15.0"^^xsd:decimal ; schema:price "1.80"^^xsd:decimal .
prod:CHOC_150 a schema:Product ; schema:name "85% Dark Chocolate"   ; schema:sku "CHOC-150" ; schema:sugarContent "6.0"^^xsd:decimal  ; schema:price "2.20"^^xsd:decimal .
"""

def insight_iri(session_id:str)->str:
    return f"<https://example.org/insight/{session_id}>"

async def run_phone_and_scanner(session_id:str):
    _bridge.addPhoneTL("PICKUP", f"session={session_id}")
    need = await n3reasoner([PROFILE, DESENSITIZE_RULE], None, to_js({"output":"derivations","outputType":"string"}))
    _bridge.addPhoneTL("DESENSITIZE", "need=needsLowSugar written")

    now = datetime.now(timezone.utc); exp = now + timedelta(hours=2)
    context = f"""@prefix ctx: <https://example.org/context#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
[] ctx:retailer "Delfour" ; ctx:device "self-scanner" ; ctx:event "pick_up_scanner" ;
   ctx:timestamp "{now.isoformat()}"^^xsd:dateTime ; ctx:expiresAt "{exp.isoformat()}"^^xsd:dateTime ."""
    INS_IRI = insight_iri(session_id)
    derive_rule = DERIVE_RULE_TPL % {"INS_IRI": INS_IRI}
    insight = await n3reasoner([context, need, derive_rule], None, to_js({"output":"derivations","outputType":"string"}))
    _bridge.addPhoneTL("INSIGHT", "envelope emitted")
    _bridge.setTxt("insightBox", insight.strip())

    policy_rule = ODRL_FROM_INSIGHT_TPL % {"INS_IRI": INS_IRI}
    policy = await n3reasoner([policy_rule, insight], None, to_js({"output":"derivations","outputType":"string"}))
    _bridge.addPhoneTL("POLICY", "ODRL policy emitted")
    _bridge.setTxt("policyBox", policy.strip())

    # sign canonicalized (insight + policy)
    sig_obj = await _bridge.signPayload(canonicalize_ttl(insight) + canonicalize_ttl(policy))
    _bridge.setTxt("sigBox", json.dumps(sig_obj.to_py(), indent=2))

    bus.write(f"{session_id}/insight.ttl", insight.strip()+"\\n")
    bus.write(f"{session_id}/policy.ttl", policy.strip()+"\\n")
    bus.write(f"{session_id}/envelope.ttl", insight.strip()+"\\n\\n"+policy.strip()+"\\n")
    bus.write(f"{session_id}/envelope.sig.json", json.dumps(sig_obj.to_py(), indent=2))

    _bridge.addScanTL("INIT", "catalog present")

    # verify signature before anything else
    ins = bus.read(f"{session_id}/insight.ttl")
    pol = bus.read(f"{session_id}/policy.ttl")
    sig = json.loads(bus.read(f"{session_id}/envelope.sig.json"))
    ok = await _bridge.verifyPayload(canonicalize_ttl(ins)+canonicalize_ttl(pol), to_js(sig))
    _bridge.addScanTL("VERIFY", "signature OK" if ok else "signature FAILED")
    if not ok:
        _bridge.setTxt("auditBox", "Signature verification failed. Aborting.")
        _bridge.setTxt("reasonBox", "Verification failed, so nothing is processed on the scanner.")
        _bridge.setChecks([["insight_nonempty", bool(insight.strip())],
                           ["minimization_no_sensitive_terms", False],
                           ["scope_has_device_event_expiry", False],
                           ["runtime_present", False],
                           ["behavior_suggests_on_high_sugar", False],
                           ["audit_has_decision", False]])
        return

    # authorization + audit
    now1 = datetime.now(timezone.utc).isoformat()
    auth_out = await n3reasoner([pol, ins,
                                 f'@prefix ex: <https://example.org/enforce#> .\\n@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .\\n[] ex:now "{now1}"^^xsd:dateTime .',
                                 EXPIRY_GUARD, ODRL_ENFORCE, AUDIT_RULES, REQUEST_USE],
                                None, to_js({"output":"derivations","outputType":"string"}))

    allowed = ("Allowed" in auth_out) and ("Blocked" not in auth_out)
    _bridge.addScanTL("AUTH", "Allowed" if allowed else "Blocked")

    # shopping
    alt_qn = None
    if allowed:
        scan = """@prefix shop: <https://example.org/shop#> .
@prefix prod: <https://example.org/product#> .
[] shop:scannedProduct prod:BIS_001 ."""
        sugg = await n3reasoner([ins, CATALOG, scan, SHOPPING_RULE], None, to_js({"output":"derivations","outputType":"string"}))
        m = re.search(r"shop:suggestedAlternative\\s+([^\\s]+)\\s*\\.", sugg)
        alt_qn = m.group(1) if m else None
        def name_for(qn:str|None)->str|None:
            if not qn: return None
            mm = re.search(re.escape(qn)+r"\\b[\\s\\S]*?schema:name\\s+\\\"([^\\\"]+)\\\"", CATALOG)
            return mm.group(1) if mm else None
        banner = {
            "headline": "Track sugar per serving while you scan",
            "product_name": name_for("prod:BIS_001") or "Unknown",
            "note": "High sugar" if alt_qn else None,
            "suggested_alternative": name_for(alt_qn) if alt_qn else None
        }
        _bridge.addScanTL("SCAN", f'product="{banner["product_name"]}"' + (f' → suggest="{banner["suggested_alternative"]}"' if banner["suggested_alternative"] else " (ok)"))
    else:
        banner = {"headline":"Policy blocked action","product_name":None,"note":"Expired or prohibited","suggested_alternative":None}

    _bridge.setTxt("bannerBox", json.dumps(banner, indent=2))

    # close-out duty + audit print
    now2 = datetime.now(timezone.utc).isoformat()
    close_out = await n3reasoner([ins,
                                  f'@prefix ex: <https://example.org/enforce#> .\\n@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .\\n[] ex:now "{now2}"^^xsd:dateTime .',
                                  EXPIRY_GUARD, AUDIT_RULES],
                                 None, to_js({"output":"derivations","outputType":"string"}))
    audit_txt = (auth_out.strip() + ("\\n" + close_out.strip() if close_out.strip() else "")).strip()
    _bridge.setTxt("auditBox", strip_prefixes(audit_txt))

    # ----- Reason Why + Checks (harness)
    reason = ("Household requires low-sugar guidance (diabetes in POD). "
              "You are starting a self-scanner session at Delfour right now. "
              "The neutral Insight is scoped to this device & event and expires soon; "
              "the policy confines use to shopping assistance.")
    _bridge.setTxt("reasonBox", reason)

    insight_txt_lc = (insight or "").lower()
    checks = [
        ["insight_nonempty", bool(insight.strip())],
        ["minimization_no_sensitive_terms", ("diabetes" not in insight_txt_lc and "medical" not in insight_txt_lc)],
        ["scope_has_device_event_expiry", all(k in insight_txt_lc for k in ["scopedevice", "scopeevent", "expiresat"])],
        ["runtime_present", True],  # we always render a banner (Allowed or Blocked)
        ["behavior_suggests_on_high_sugar", bool(alt_qn)],
        ["audit_has_decision", ("activity#Decision" in audit_txt) or ("act:Decision" in audit_txt)],
    ]
    _bridge.setChecks(to_js(checks))

async def run_demo(session_id:str):
    _bridge.addPhoneTL("READY", f"session={session_id}")
    await run_phone_and_scanner(session_id)
    _bridge.addScanTL("DONE", "")
`;

    async function runDemo(){
      resetUI();
      runBtn.disabled = true;
      setStatus("Running…");
      try{
        const sess = $("sessionId").value || "S1";
        await pyodide.runPythonAsync(py + `\nawait run_demo("${sess}")\n`);
        setStatus("Done.");
      }catch(e){
        console.error(e);
        setStatus("Error: " + (e?.message || e));
      }finally{
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener("click", runDemo);
    setStatus("Ready.");
  </script>
</body>
</html>

